<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="application-name" content="snippets" data-template="<%= t %>">
<title>30 seconds of code: <%= t %></title>
<style>
  body { font-family: sans-serif; }
  h2, pre {
    white-space: pre-wrap;
    overflow-wrap: break-word;
  }
  a { text-decoration: none; }
  pre { background: #fafafa; }
  iframe { width: 100%; }
  :root {
    --body-width: 900px;
    --toc-width: 260px;
    --doc-width: 640px;
    --margin-left: calc(100%/2 - var(--body-width)/2 + var(--toc-width))
  }
  #toc { display: none; }
  #toc ul { padding-left: 20px; }
  #toc > div {
    margin: 1em 0 1em auto;
    width: calc(var(--toc-width) - 1em);
  }

  @media screen and (min-width: 900px) {
    body { margin: 0; }
    #doc {
      width: var(--doc-width);
      margin-left: var(--margin-left);
    }
    #toc {
      display: block;
      position: fixed;
      top: 0;
      bottom: 0;
      width: calc(var(--margin-left) - 1em);
      min-width: calc(var(--toc-width) - 1em);
      overflow-x: auto;
      overflow-y: scroll;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', main)

  function main() {
      if (template_type() === 'css') mk_previews()
      let list = mk_list()
      document.querySelector('#toc input').oninput = evt => {
          render(list, evt.target.value)
      }
      render(list)
  }

  function template_type() {
      return document.querySelector('meta[name="application-name"]').dataset.template
  }

  function mk_previews() {
      for (let article of document.querySelectorAll('article')) {
          article.querySelector('h2').insertAdjacentHTML('afterend', '<button class="preview">Preview</button>\n<button class="codepen">CodePen</button><div style="margin: 1em 0" class="preview" />')
      }

      let preview_handler = evt => {
          let article = document.getElementById(evt.target.parentElement.id)
          let preview = article.querySelector('div.preview')
          if (preview.childElementCount) { // has iframe
              preview.textContent = ''
              return
          }
          inject_iframe(preview, page(article))
      }
      let page = article => {
          let r = ['html', 'css', 'js'].map( v => {
              let node = article.querySelector(`pre.${v} > code`)
              return node && node.textContent
          })
          return { html: r[0], css: r[1], js: r[2] }
      }
      let codepen_handler = evt => {
          let article = document.getElementById(evt.target.parentElement.id)
          let payload = page(article)
          payload.title = article.querySelector('h2').innerText

          let form = document.createElement('form')
          form.style.display = 'none'
          form.action = 'https://codepen.io/pen/define'
          form.method = 'POST'
          form.target = '_blank'
          form.innerHTML = '<input name="data">'
          form.querySelector('input[name]').value = JSON.stringify(payload)

          article.appendChild(form)
          form.submit()
          form.remove()
      }

      for (let btn of document.querySelectorAll('button.preview')) {
          btn.onclick = preview_handler
      }
      for (let btn of document.querySelectorAll('button.codepen')) {
          btn.onclick = codepen_handler
      }
  }

  function inject_iframe(parent, {html, css, js}) {
      let node = document.createElement('iframe')
      node.srcdoc = ['<!doctype html>', `<style>${css}</style>`, html,
                     (js ? `<script>${js}<\/script>` : '')].join`\n`
      parent.appendChild(node)
      node.contentWindow.onload = () => {
          let cur = node.contentWindow.document.body.scrollHeight
          if (cur > 150) node.height = cur + 16
      }
  }

  function mk_list() {
      let h2s = [...document.querySelectorAll('h2')].map( v => v.innerText)
      return query => {
          return query ? h2s.filter( v => v.toLowerCase().indexOf(query.toLowerCase()) !== -1) : h2s
      }
  }

  function render(list, filter) {
      document.querySelector('#toc__list').innerHTML = list(filter).map( v => {
          return `<li><a href="#${v}">${v}</a></li>`
      }).join`\n`
  }

</script>

<nav id="toc"><div><input type="search"><ul id="toc__list"></ul></div></nav>
<main id="doc">
